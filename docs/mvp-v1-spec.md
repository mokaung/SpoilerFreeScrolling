# MVP v1 – Spec & File Structure

## Overview

- **v1** includes **keyword detection** only; AI classifier is planned for v2.
- **Extension UI** is shown in the browser window as a **side panel** (not a separate popup window). The same **`index.html`** is used as `side_panel.default_path`; clicking the extension icon opens the side panel.
- **Edit** is inline on the Profile Detail view (no separate Edit page). Back button goes to the previous screen (list from detail, or exit edit mode from detail).
- **Common UI** uses **shadcn/ui** (Radix primitives) where possible; app-specific pieces (SearchBar, FilterButtons, modals, etc.) compose them.
- **Modals** use shadcn **Dialog**; Warning and Delete confirmation share the same primitive; only content and actions differ.
- **One profile = one piece of media:** one book series, one TV show, one movie franchise, or one game series. Media type semantics: **Book** = series; **TV** = show (no sequel concept); **Movie** = franchise; **Game** = series (e.g. Yakuza 0, 1, 2…).

---

## Popup shell, layout & theme

- **Position & size:** The UI is a **side panel** in the browser window (large and tall) (e.g. substantial width and min-height so it feels spacious). Use **rounded corners** for the popup container. Internal content uses consistent spacing (padding/margins). Where the platform allows, the popup is positioned toward the **top-right with spacing** (e.g. via manifest or window placement if supported; otherwise rely on a large, rounded frame).
- **Header (fixed at top of panel):**
  - **Left:** Extension **icon** (use the best size for the header—e.g. 32px or 48px from `icon48.png` / `icon128.png`), then **“Spoiler Free Scrolling”** as the title, immediately after the icon.
  - **Right:** **Settings** button (icon only, e.g. gear) → opens Settings view; **Close** button (X icon) → closes the side panel (e.g. `window.close()`).
  - **Shadcn for header:** Use **Button** with `variant="ghost"` and `size="icon"` for Settings and Close (with Lucide **Settings** and **X** icons). Put icon + title in a flex row; use a spacer so the two icon buttons sit on the right. Optional: **Separator** below the header to divide it from the content area. No need for a full Sheet/Dialog—the header is a simple flex row inside the popup.
- **Typography:** **Global font is Inter.** Load Inter (e.g. Google Fonts or npm) and set it as the default font family for the popup.
- **Colors:** Base UI is **white** (or light) where appropriate. **Accent color is `#fd5342`.** Add this to the theme/palette (e.g. Tailwind config or CSS variable `--accent` / `--primary`) and use it for primary actions, links, or highlights so the accent is consistent across the app.

---

## Data & behavior (implementation contract)

- **Types** live in `src/shared/types.ts` (e.g. `MediaProfile`, `KeyWordRule`). Use them for all popup and storage code.
- **Progress** is stored as a **single string** (`userProgress`). The UI collects type-specific inputs and formats them into this string before save. The LLM receives this string (plus optional extra context) and interprets intent.
- **Progress inputs by media type (Create & Edit):**
  - **Book (series):** Prompt for **chapter** (e.g. “Chapter 5”) and an optional **additional info** freeform field (e.g. “just finished the trial”). Both are sent to the LLM; store a single string (e.g. `"Chapter 5"` or `"Chapter 5. Just finished the trial."`).
  - **TV (show):** Prompt for **season** and **episode** (e.g. S3 E5). No sequel concept. Store as a single string (e.g. `"S3 E5"` or `"Season 3 Episode 5"`).
  - **Movie (franchise):** No progress inputs for MVP (single movie = one sitting). Optional: later, franchise progress could be a freeform “seen through X” or similar.
  - **Game (series):** One **additional info** / “where you’re at” freeform field only (e.g. “Just beat first boss, in swamp”). Stored as `userProgress`; sent to LLM as-is.
- **Keywords:** Generated by an **LLM API**. Input: title (topic), media type, `userProgress` string, and optional additional context. The **LLM must return strict formatted JSON** (or equivalent) so the app can parse and convert into `KeyWordRule[]`. Example contract: `{ "keywords": [ { "term": string, "riskLevel": number } ] }` with `riskLevel` 0–10. The app ingests this, maps to `KeyWordRule[]`, and persists; display in Keywords section with risk levels (e.g. “walter dies (10/10)”).
- **Stats** (tweets blocked, last blocked, active since): Populated by the tweet-detecting content script when implemented; popup reads from storage. Until then, show placeholders or zeros.
- **Sensitivity (slider 0–10):** Used internally with risk levels/keywords. **Do not explain risk levels or keywords in the UI**—doing so would encourage users to look at keywords and spoil themselves. Present the control in a **spoiler-safe** way only: e.g. label it “Strictness” or “How strict?” with minimal copy such as “More = block more posts / Less = block fewer” (or similar). No tooltip or link that mentions “risk levels,” “keywords,” or how blocking works under the hood.
- **Keyword generation methods (overview):** Three options are planned: (1) **User’s own API key for Claude** (paid), (2) **User’s own API key for ChatGPT** (paid), (3) **OpenRouter** using **free models only** (e.g. OpenRouter’s free model IDs or `:free` variant). **v1:** Only (3) OpenRouter. No user API key in v1.
- **v1 implementation (OpenRouter only):** Use **OpenRouter** with **free models only** (e.g. model IDs with `:free` suffix or from OpenRouter’s free model list). The **developer’s** OpenRouter API key is **kept in the extension** (e.g. in env or a non-committed config); no backend in v1. Restrict usage to free models by **only ever requesting free model IDs** in code (no paid model IDs). Consider setting the OpenRouter key **credit limit to $0** (if supported) to limit abuse. **Settings in v1:** No API key input. Show short copy: e.g. “Keyword generation uses OpenRouter (free models). No setup needed.” **Regenerate keywords in v1:** Always calls OpenRouter with a free model; no “add API key” prompt.
- **v1.1 (later):** Add a **lightweight backend** that stores (1) the **OpenRouter key** and (2) **user-provided Claude/ChatGPT keys** (per user/account). Extension calls the backend for keyword generation; backend routes to OpenRouter or Claude/ChatGPT and never exposes keys to the client. Provider choice (OpenRouter free | Claude | ChatGPT) in Settings; user keys for Claude/ChatGPT stored on backend instead of in the extension.

---

## Progress display by media type (list & detail)

When showing **progress** in the UI (e.g. in each list row, or on Detail), **render it differently by media type** so it’s scannable and consistent:

- **Book:** Display the stored string as-is, or normalize to a short form (e.g. “Ch 5” or “Chapter 5”). If there’s additional info, show chapter first; optional: truncate or hide extra in list.
- **TV:** Display as season/episode (e.g. “S3 E5” or “Season 3, Ep 5”). Parse from stored string if needed.
- **Movie:** Do **not** show progress at all (omit the progress cell/field in list row and on Detail).
- **Game:** Show the freeform string; in list row, truncate if long (e.g. first N characters + “…”).

Use this for: **Main list row** (topic, **progress** where applicable, chevron, delete) and **Detail** read-only progress display. For Movie, the row and Detail have no progress column/cell.

---

## Creation: series vs individual media

Use a **single create flow** for all profiles. Do **not** add a separate control (e.g. “Series or single?”) or different screens for “create series profile” vs “create single item profile.”

- **How it works:** The user chooses **Title** and **Media type** and, where applicable, **Progress**. The title can represent either a series or a single piece of media (e.g. “Breaking Bad”, “Harry Potter series”, “Yakuza 2”, “Spider-Man: No Way Home”). Progress then refines where they are (chapter, season/episode, freeform, or none for movie). One profile = one row in the list; the same form supports both.
- **UI:** One Create Profile form. Optional short **helper text** per media type to set expectations (e.g. for Title: “e.g. show name, book/series name, game, or movie/franchise”). No toggles or sub-types for “series vs individual”; the user’s intent is captured by title + progress.
- **List layout:** If the list has a dedicated progress column, **omit the progress cell for Movie** (leave cell empty or hide the column for that row). For Book, TV, and Game, show progress as in **Progress display by media type**.

---

## MVC – Action List (v1)

Implement the popup so that every screen, field, and action below exists and behaves as described. An LLM or developer reading this section should be able to build the UI without ambiguity.

### Main Profile List View

- **Layout:** List of profiles (one row per profile). No cards.
- **Each row:** **Toggle switch** (left) to enable/disable spoiler blocking for the profile, **Topic name** (profile title), **progress** (formatted by media type—see **Progress display by media type**; Book: “Ch 5”, TV: “S3 E5”, Movie: omit progress entirely, Game: truncated freeform), **chevron** (right) to indicate clickable, **delete** button (e.g. icon). Row (and chevron) navigate to Profile Detail. Toggle switch immediately updates the profile's enabled state. Delete opens Delete confirmation modal; on confirm, remove profile and stay on list.
- **Controls above list:** Search (by title), filter by media type (All, TV, Movie, Game, Book), sort (A–Z, Z–A, Newest First, Oldest First, Enabled First). Use shared SearchBar, FilterButtons, SortDropdown.
- **Actions:** “New” button → Create Profile Page. **Settings** is in the global header (gear icon) → Settings view. No edit from list; edit only from Detail.
- **Empty state:** When there are no profiles (or none match search/filter), show an empty state and a clear way to create the first profile (e.g. “No profiles” + “New” or equivalent).

### Create Profile Page

- **Back** button → Main list (no save).
- **Fields (all required unless marked optional):**
  - **Title** – Text input (e.g. book/series name, show name, franchise name, game series name).
  - **Media type** – Select: Book | TV | Movie | Game.
  - **Progress – show inputs based on media type:**
    - **Book:** Chapter input (e.g. “Chapter 5”), plus optional “Additional info” text area (sent to LLM as extra context). Persist as a single `userProgress` string.
    - **TV:** Season number, episode number (e.g. two number inputs or combined). Persist as single string (e.g. `"S3 E5"`).
    - **Movie:** No progress inputs for v1.
    - **Game:** Single “Where you’re at” / “Additional info” freeform field. Persist as `userProgress`.
  - **Sensitivity** – Slider 0–10 (use SensitivitySlider / shadcn Slider). **Spoiler-safe UI only:** Label as “Strictness” or “How strict?” with minimal copy (e.g. “More = block more / Less = block fewer”). Do not mention risk levels, keywords, or how blocking works.
  - **Allowed accounts** – Add/remove list of account handles (use AllowedAccountsInput).
- **Actions:** **Save** → Validate, create profile (and optionally trigger keyword generation or leave keywords empty until “Regenerate” on Detail), then navigate to Main list. **Cancel** → Main list without saving.

### Profile Detail Page

- **Back** button → Main list (when in view mode).
- **Content (read-only when not in edit mode):**
  - All profile info: title, media type, **progress** (display formatted by media type—see **Progress display by media type**; omit entirely for Movie), **sensitivity** (label spoiler-safe, same as Create), enabled state.
  - **Stats:** tweets blocked, last blocked timestamp, active since (from storage; placeholder/zero until content script provides data). Use ProfileStats.
  - **Allowed accounts:** Read-only list (no add/remove in view mode).
  - **Keywords:** Short explanation of risk levels at top. List of keywords with risk levels (e.g. “walter dies (10/10)”). “View keywords” or entering the section may show **Warning modal** (spoiler warning) first, then reveal keywords.
- **Actions (view mode):**
  - **Regenerate keywords** – **v1:** Call OpenRouter (free model only) with title, media type, `userProgress`, and optional extra context; LLM returns strict JSON; parse into `KeyWordRule[]`, save, then refresh. No API key check; no “add key” prompt. Show LoadingSpinner during request; on success, update displayed keywords. (Later: if provider is Claude/ChatGPT and no user key is set, show prompt to add key in Settings.)
  - **Edit** – Switch to edit mode (same screen; fields become editable).
  - **Delete** – Open Delete confirmation modal; on confirm, delete profile and navigate to Main list.
  - **Toggle enabled** – Inline toggle for profile enabled state; persist immediately.
- **Edit mode (inline, same screen):**
  - All Create fields shown, pre-filled: title, media type, **progress inputs again by type** (Book: chapter + optional info; TV: season/episode; Movie: none; Game: freeform), sensitivity (same spoiler-safe label/copy as Create), allowed accounts (use AllowedAccountsInput for add/remove).
  - **Save** → Persist changes, then switch back to read-only detail view.
  - **Cancel** or **Back** → Switch back to read-only detail without saving.

Editing is only from Detail (no edit action on the list). There is no separate “Edit Profile Page”; edit is a mode of Profile Detail.

### Modals

- Use shadcn **Dialog** for both. Same layout primitive; only content and actions differ.
  - **Warning modal:** Shown before revealing keywords (spoiler warning). Content and confirm/cancel as needed.
  - **Delete confirmation modal:** “Delete this profile?” (or similar); Confirm → delete and navigate; Cancel → close.

### Settings

- **Entry:** From Main Profile List View only: **Settings** control (e.g. gear icon in header or “Settings” link). Opens Settings view. Back button returns to Main list.
- **v1 content:** No API key input. Show a short **keyword generation** section with copy such as: “Keyword generation uses OpenRouter (free models). No setup needed.” Spoiler-safe; do not mention risk levels or keywords. (Reserve space or structure for future provider/key options.)
- **Later (post-v1):** Add **provider** choice (e.g. OpenRouter free | Claude | ChatGPT). For Claude and ChatGPT: masked API key input, Save, Clear; key stored in `chrome.storage.local` only; helper copy “Stored only on your device. Used only for keyword generation.” Do not display the raw key after save.

---

## v1.1 considerations

- **Lightweight backend:** Backend stores the **OpenRouter key** and **user Claude/ChatGPT keys** (per user/account). Extension calls the backend for keyword generation; backend routes to OpenRouter or Claude/ChatGPT and keeps keys server-side. Enables provider choice (OpenRouter free | Claude | ChatGPT) without storing user keys in the extension.

## v2 considerations

- **AI classifier:** Toggle in Create Profile and in Profile Detail (edit mode) to enable/disable AI-based spoiler detection alongside keyword detection.
- **Keyword generation providers:** Add provider choice in Settings (OpenRouter free | Claude | ChatGPT). For Claude and ChatGPT, user provides their own API key (masked input, stored in `chrome.storage.local` or on backend in v1.1). Regenerate then uses the selected provider and, for Claude/ChatGPT, prompts to add key in Settings if missing.

---

## File Structure (v1)

Popup UI lives under `src/popup/`. The popup HTML is the root **`index.html`** (not inside `src/popup/`). Common UI is built with **shadcn/ui** (Radix primitives); app-specific components compose them.

```
src/popup/
├── index.css
├── main.tsx                          # Entry: mounts App, imports CSS
├── App.tsx                           # Router / view state (list | create | detail | settings)
└── components/
    ├── PopupHeader.tsx                # Shell: icon + "Spoiler Free Scrolling" + Settings (ghost icon) + Close (ghost icon)
    ├── ui/                            # shadcn (Radix primitives) – add via npx shadcn@latest add
    │   ├── button.tsx
    │   ├── dialog.tsx                # Base for modals (Warning, DeleteConfirm)
    │   ├── input.tsx
    │   ├── select.tsx
    │   ├── slider.tsx
    │   ├── switch.tsx                # Toggle switch for enabling/disabling profiles
    │   └── label.tsx                 # As needed for forms
    ├── views/
    │   ├── MainView.tsx               # List + search / filter / sort; Settings entry (gear/link)
    │   ├── CreateProfileView.tsx      # Full create page (AI classifier planned for v2)
    │   ├── ProfileDetailView.tsx      # Detail + inline edit mode (AI classifier in edit mode planned for v1.1)
    │   └── SettingsView.tsx          # v1: OpenRouter (free) copy, no key input; later: provider + key inputs
    ├── profile/
    │   ├── ProfileList.tsx            # Renders list of profile rows
    │   ├── ProfileListRow.tsx        # Row: topic name, progress (by type), chevron, delete (uses Button)
    │   ├── ProfileStats.tsx
    │   └── KeywordsSection.tsx
    └── shared/                       # App-specific, compose shadcn ui
        ├── BackButton.tsx            # Button + chevron/arrow (previous page)
        ├── SearchBar.tsx             # uses Input
        ├── FilterButtons.tsx         # uses Button
        ├── SortDropdown.tsx          # uses Select
        ├── SensitivitySlider.tsx     # uses Slider
        ├── AllowedAccountsInput.tsx  # uses Input + list
        ├── WarningModal.tsx          # uses Dialog
        ├── DeleteConfirmModal.tsx    # uses Dialog
        └── LoadingSpinner.tsx        # e.g. Lucide Loader2 + animate-spin (shadcn often uses Lucide)
```

- **Root (project):** `index.html` = popup page; script entry is `src/popup/main.tsx` (or equivalent bundle path).
- **Popup shell:** Use **PopupHeader** at the top of every view (icon + “Spoiler Free Scrolling” + Settings + Close). Popup container: large, tall, rounded; font Inter; accent `#fd5342`. See **Popup shell, layout & theme**.
- **ui/:** shadcn components (Radix primitives). Add with `npx shadcn@latest add <component>`. Use for Button, Dialog, Input, Select, Slider, Label as needed.
- **shared/:** App compositions that use `ui/` (e.g. SearchBar wraps Input, WarningModal/DeleteConfirmModal use Dialog). No custom Button/Modal; use shadcn and compose here.
- **BackButton:** Uses shadcn Button + icon; navigates to previous page (list ← detail, or exit edit mode).
- **Profile list:** Rendered as rows. Each row shows **toggle switch** (left) for enabling/disabling spoiler blocking, topic name, **progress (formatted by media type)**, chevron, delete. `ProfileListRow` uses shadcn Switch for toggle, Button for delete, and row click/chevron; progress display follows **Progress display by media type**.
- **ProfileDetailView:** Read-only allowed accounts as a list; in edit mode uses `AllowedAccountsInput`. Progress and keywords behavior follow **Data & behavior** (progress by media type, LLM JSON for keywords). v1: Regenerate calls OpenRouter (free model) with no key check.
- **SettingsView:** v1: Keyword generation copy only (“OpenRouter free models. No setup needed.”). No API key input. Back to Main list. Later: provider choice and Claude/ChatGPT key inputs.
- **LoadingSpinner:** Lucide `Loader2` with Tailwind `animate-spin`, or equivalent; used during Regenerate keywords.
